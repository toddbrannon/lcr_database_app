  <!-- Include the navbar partial -->
  <%- include ('partials/header', { isLoggedIn: isLoggedIn, isAdmin: isAdmin }) -%>

  <div class="container-fluid mt-5 mb-5 pb-5">
    <h1 class="mx-4 mt-5 mb-3">Employee Hours Report</h1>

    <form action="/pivot" method="GET">
        <label class = "text-info-lcr ml-4 mr-1 pl-2" for="citySelect">Select City:</label>
        <select name="city" id="citySelect" class="py-1 pr-2 pl-2">
            <option value="Lahaina">Lahaina</option>
            <option value="Puyallup">Puyallup</option>
            <!-- Add more options based on your cities -->
        </select>
        <button type="submit" class="btn btn-info-lcr btn-sm mb-1">Filter</button>
        <label class = "text-info-lcr ml-4 mr-1 pl-2" for="citySelect">Hours threshold:</label>
        <input type="number" id="thresholdValue" name="thresholdValue" min="1" max="999" />
        <button type="button" id="applyButton" class="btn btn-info-lcr btn-sm mb-1">Apply</button>
        <button type="button" id="clearButton" class="btn btn-info-lcr btn-sm mb-1" style="display: none;">Clear</button>
        <button type="button" id="exportBtn" class="btn btn-info-lcr btn-sm mb-1 ml-4">Export to Excel</button>

    </form>

    <% for (const jobDesc of jobDescriptions) { %>
        <h5 class="mt-2 mx-4 text-secondary"><%= jobDesc %></h5>
        <div class = "fixed-first-column" style="overflow-x: auto; overflow-y: auto; max-height: 400px;"> <!-- Add this div with overflow-x style -->
        <table id="dataTable" class="table table-striped mx-4 mx-lg-1 px-4 table-bordered fixed-header">
            <thead>
                <tr>
                    <th class="name-column">Name</th>
                    <th>City</th>
                    <% if (periodEnds.length > 0) { %>
                      <% for (const periodEnd of formattedPeriodEnds) { %>
                          <th><%= periodEnd %></th>
                      <% } %>
                  <% } %>
                </tr>
            </thead>
            <tbody>
              <% for (const key in data) {
                  const employeeData = data[key];
                  if (employeeData.JobDescription === jobDesc) { %>
                      <tr>
                          <td class="name-cell"><%= employeeData.Name %></td>
                          <td><%= employeeData.City %></td>
                          <% if (periodEnds.length > 0) { %>
                              <% for (const periodEnd of formattedPeriodEnds) { %>
                                  <td><%= employeeData.PeriodEnds[periodEnd] || 0 %></td>
                              <% } %>
                          <% } %>
                      </tr>
              <%   }
              } %>
          </tbody>
          <!-- New tfoot for the count row -->
          <tfoot>
                <tr>
                <td colspan="2">Count</td> <!-- colspan=2 for Name and City columns -->
                <% formattedPeriodEnds.forEach(function() { %>
                    <td class="count-cell"></td> <!-- Empty cell for each date column -->
                <% }); %>
                </tr>
          </tfoot>
          
        </table>
        </div> <!-- Close the div here -->
        <% } %>
      
  </div>

  <script>

    document.getElementById('thresholdValue').addEventListener('input', function() {
        var value = this.value;
        var clearButton = document.getElementById('clearButton');
        if (value) {
            clearButton.style.display = 'inline-block'; // Show the button
        } else {
            clearButton.style.display = 'none'; // Hide the button
        }
    });

    document.getElementById('applyButton').addEventListener('click', function() {
        var threshold = document.getElementById('thresholdValue').value;
        threshold = parseInt(threshold, 10);
        this.blur(); // Remove focus from the button

        // Validate the input
        if (isNaN(threshold) || threshold < 1 || threshold > 999) {
            alert('Please enter a number between 1 and 999');
            return;
        }

        // Apply formatting to the tables
        document.querySelectorAll('#dataTable tbody tr td').forEach(function(td) {
            var value = parseFloat(td.textContent);
            if (!isNaN(value) && value > threshold) {
                td.style.backgroundColor = 'lightgreen';
            } else {
                td.style.backgroundColor = ''; // Reset the background
            }
        });
    });
    document.getElementById('clearButton').addEventListener('click', function() {
        // Clear the input field
        document.getElementById('thresholdValue').value = '';
        clearButton.style.display = 'none'; // Hide the button
        this.blur(); // Remove focus from the button

        // Remove formatting from the tables
        document.querySelectorAll('#dataTable tbody tr td').forEach(function(td) {
            td.style.backgroundColor = ''; // Reset the background
        });
    });
    function updateCounts() {
        var threshold = parseInt(document.getElementById('thresholdValue').value, 10) || 0;
    
        // For each job description table
        document.querySelectorAll('.table').forEach(function(table) {
          var countCells = table.querySelectorAll('tfoot .count-cell');
          countCells.forEach(function(cell, index) {
            var count = 0;
            // Calculate count for each column
            table.querySelectorAll('tbody tr').forEach(function(row) {
              var cellValue = parseFloat(row.cells[index + 2].textContent); // +2 to skip Name and City
              if (cellValue > threshold) count++;
            });
            cell.textContent = count; // Update the count cell
          });
        });
      }
    
      document.getElementById('applyButton').addEventListener('click', updateCounts);
      document.getElementById('clearButton').addEventListener('click', function() {
        document.querySelectorAll('.count-cell').forEach(function(cell) {
          cell.textContent = ''; // Clear the count cells
        });
        updateCounts(); // Recalculate counts (will be zero if cleared)
      });


        
      // Export to Excel
      document.getElementById('exportBtn').addEventListener('click', function() {
        console.log('Exporting to Excel...');
        const groupedData = [];
        document.querySelectorAll('.group-container').forEach(groupContainer => {
          const jobDesc = groupContainer.querySelector('.job-description').textContent;
          const table = groupContainer.querySelector('table');
          const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent);
  
          const data = [];
          table.querySelectorAll('tbody tr').forEach(row => {
              const rowData = {};
              row.querySelectorAll('td').forEach((cell, index) => {
                  const headerKey = headers[index].toLowerCase().replace(/\s+/g, '_');
                  rowData[headerKey] = cell.textContent;
              });
              data.push(rowData);
          });
  
          groupedData.push({ jobDesc, headers, data });
      });
  
      fetch('/export', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ groupedData })
      })
      .then(response => response.blob())
      .then(blob => {
        // Create a link element, use it to download the file, then delete the link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'report.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      });
    });

</script>

<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const table = document.getElementById('dataTable');
        if (!table) {
          console.error('Table not found!');
          return;
        }
      
        const exportBtn = document.getElementById('exportBtn');
        if (!exportBtn) {
          console.error('Export button not found!');
          return;
        }
      
        // Rest of your event listener code...
        console.log('DOM fully loaded and parsed');
      });
</script>

    
</body>  

</html>
